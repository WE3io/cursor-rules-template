<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Preparatory Refactoring | AI Blindspots</title>
<meta name=title content="Preparatory Refactoring"><meta name=description content="Preparatory Refactoring
says that you should first refactor to make a change easy, and then make the
change.  The refactor change can be quite involved, but because it is
semantics preserving, it is easier to evaluate than the change itself.
Current LLMs, without a plan that says they should refactor first, don&rsquo;t
decompose changes in this way.  They will try to do everything at once.  They
also sometimes act a bit too much like that overenthusiastic junior engineer
who has taken the Boy Scout principle too seriously and keeps cleaning up
unrelated stuff while they&rsquo;re making a change.  Reviewing LLM changes is
important, and to make review easy, all of the refactors should happen ahead
of time as their own proposed changes."><meta name=keywords content><meta property="og:url" content="https://ezyang.github.io/ai-blindspots/preparatory-refactoring/"><meta property="og:site_name" content="AI Blindspots"><meta property="og:title" content="Preparatory Refactoring"><meta property="og:description" content="Preparatory Refactoring says that you should first refactor to make a change easy, and then make the change. The refactor change can be quite involved, but because it is semantics preserving, it is easier to evaluate than the change itself.
Current LLMs, without a plan that says they should refactor first, don’t decompose changes in this way. They will try to do everything at once. They also sometimes act a bit too much like that overenthusiastic junior engineer who has taken the Boy Scout principle too seriously and keeps cleaning up unrelated stuff while they’re making a change. Reviewing LLM changes is important, and to make review easy, all of the refactors should happen ahead of time as their own proposed changes."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-03-03T21:24:52-05:00"><meta property="article:modified_time" content="2025-03-03T21:24:52-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Preparatory Refactoring"><meta name=twitter:description content="Preparatory Refactoring says that you should first refactor to make a change easy, and then make the change. The refactor change can be quite involved, but because it is semantics preserving, it is easier to evaluate than the change itself.
Current LLMs, without a plan that says they should refactor first, don’t decompose changes in this way. They will try to do everything at once. They also sometimes act a bit too much like that overenthusiastic junior engineer who has taken the Boy Scout principle too seriously and keeps cleaning up unrelated stuff while they’re making a change. Reviewing LLM changes is important, and to make review easy, all of the refactors should happen ahead of time as their own proposed changes."><meta itemprop=name content="Preparatory Refactoring"><meta itemprop=description content="Preparatory Refactoring says that you should first refactor to make a change easy, and then make the change. The refactor change can be quite involved, but because it is semantics preserving, it is easier to evaluate than the change itself.
Current LLMs, without a plan that says they should refactor first, don’t decompose changes in this way. They will try to do everything at once. They also sometimes act a bit too much like that overenthusiastic junior engineer who has taken the Boy Scout principle too seriously and keeps cleaning up unrelated stuff while they’re making a change. Reviewing LLM changes is important, and to make review easy, all of the refactors should happen ahead of time as their own proposed changes."><meta itemprop=datePublished content="2025-03-03T21:24:52-05:00"><meta itemprop=dateModified content="2025-03-03T21:24:52-05:00"><meta itemprop=wordCount content="284"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:800px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--code-background-color:#f2f2f2;--code-color:#222;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#333;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--code-background-color:#777;--code-color:#ddd;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px}blockquote{border-left:1px solid #999;color:var(--code-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{padding:1px 15px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ai-blindspots/ class=title><h2>AI Blindspots</h2></a><nav><a href=/ai-blindspots/>Home</a>
<a href=/ai-blindspots/blog>Blog</a></nav></header><main><h1>Preparatory Refactoring</h1><p><i><time datetime=2025-03-03>2025-03-03</time></i></p><content><p><a href=https://martinfowler.com/articles/preparatory-refactoring-example.html>Preparatory Refactoring</a>
says that you should first refactor to make a change easy, and then make the
change. The refactor change can be quite involved, but because it is
semantics preserving, it is easier to evaluate than the change itself.</p><p>Current LLMs, without a plan that says they should refactor first, don&rsquo;t
decompose changes in this way. They will try to do everything at once. They
also sometimes act a bit too much like that overenthusiastic junior engineer
who has taken the Boy Scout principle too seriously and keeps cleaning up
unrelated stuff while they&rsquo;re making a change. Reviewing LLM changes is
important, and to make review easy, all of the refactors should happen ahead
of time as their own proposed changes.</p><p>Ideally, the LLM would be instructed to not do irrelevant refactors (NB:
anecdotally, Cursor Sonnet 3.7 is not great at instruction following, so this
doesn&rsquo;t work as well as you&rsquo;d hope sometimes). Alternately, a pre-pass on the
code the LLM expects to touch potentially should be done to give the LLM a
chance to do whatever refactoring it wants to do before it actually makes its
change. Sometimes, context instructing the model to do good practices (like
making code have explicit type annotations) can make this problem worse, since
arguably the model was instructed to add annotations. Accurately determining
the span of code the LLM should edit could also help.</p><h2 id=examples>Examples</h2><ul><li>I instructed an LLM to fix an import error from local changes I made in a
file, but after fixing the imports it also added type annotations to some
unannotated lambdas in the file. Adding insult to injury, it did one of the
annotations incorrectly, leading to an agent loop spiral.</li></ul></content><p></p></main><footer></footer></body></html>